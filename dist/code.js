(()=>{"use strict";function e(e){const t=Math.round(255*e.r).toString(16).padStart(2,"0"),n=Math.round(255*e.g).toString(16).padStart(2,"0"),o=Math.round(255*e.b).toString(16).padStart(2,"0");return"a"in e&&void 0!==e.a&&1!==e.a?`#${t}${n}${o}${Math.round(255*e.a).toString(16).padStart(2,"0")}`:`#${t}${n}${o}`}function t(e,t){switch(e){case"COLOR":return"color";case"FLOAT":return"number"==typeof t?"number":"string"==typeof t&&(t.endsWith("px")||t.endsWith("rem")||t.endsWith("em")||t.endsWith("%"))?"dimension":"number";case"STRING":return"string";case"BOOLEAN":return"boolean";default:return"number"==typeof t?"number":"string"==typeof t?t.startsWith("#")||t.startsWith("rgb")?"color":t.match(/\d+(\.\d+)?(px|rem|em|%)/)?"dimension":t.startsWith("{")&&t.endsWith("}")?"reference":"string":"boolean"==typeof t?"boolean":"string"}}function n(e,t,n=""){const o={$value:e,$type:t};return n&&(o.$description=n),o}function o({r:e,g:t,b:n,a:o=1}){const r=Math.round(255*e),s=Math.round(255*t),a=Math.round(255*n);return void 0!==o&&o<1?`rgba(${r}, ${s}, ${a}, ${o.toFixed(2)})`:`rgb(${r}, ${s}, ${a})`}function r({r:e,g:t,b:n,a:o=1}){var r;const s=function({r:e,g:t,b:n,a:o=1}){const r=Math.max(e,t,n),s=Math.min(e,t,n),a=r-s;let i=0,c=0,l=(r+s)/2;if(0!==a)switch(c=l>.5?a/(2-r-s):a/(r+s),r){case e:i=60*((t-n)/a+(t<n?6:0));break;case t:i=60*((n-e)/a+2);break;case n:i=60*((e-t)/a+4)}return{h:i,s:100*c,l:100*l,a:o}}({r:e,g:t,b:n,a:o});return void 0!==o&&o<1?`hsla(${Math.round(s.h)}deg, ${Math.round(s.s)}%, ${Math.round(s.l)}%, ${null===(r=s.a)||void 0===r?void 0:r.toFixed(2)})`:`hsl(${Math.round(s.h)}deg, ${Math.round(s.s)}%, ${Math.round(s.l)}%)`}function s(e,t,n=new Set){if(!e||"string"!=typeof e)return{value:e,type:"unknown",isResolved:!1};if(!e.startsWith("{")||!e.endsWith("}"))return{value:e,type:"unknown",isResolved:!1};const o=e.substring(1,e.length-1);if(n.has(o))return console.warn(`Circular reference detected: ${o}`),{value:e,type:"reference",originalReference:e,isResolved:!1};if(n.add(o),t[o]){const r=t[o];if("string"==typeof r.value&&r.value.startsWith("{")&&r.value.endsWith("}")){const a=s(r.value,t,n);return Object.assign(Object.assign({},a),{originalReference:e,originalPath:r.originalPath,resolvedFrom:o})}return{value:r.value,type:r.type,originalReference:e,originalPath:r.originalPath,isResolved:!0,resolvedFrom:o}}const r=o.includes("/")?o.replace(/\//g,"."):o.replace(/\./g,"/");if(t[r]){const o=t[r];if("string"==typeof o.value&&o.value.startsWith("{")&&o.value.endsWith("}")){const a=s(o.value,t,n);return Object.assign(Object.assign({},a),{originalReference:e,originalPath:o.originalPath,resolvedFrom:r})}return{value:o.value,type:o.type,originalReference:e,originalPath:o.originalPath,isResolved:!0,resolvedFrom:r}}const a=o.split(/[\/\.]/).pop()||"";if(a!==o&&t[a]){const o=t[a];if("string"==typeof o.value&&o.value.startsWith("{")&&o.value.endsWith("}")){const r=s(o.value,t,n);return Object.assign(Object.assign({},r),{originalReference:e,originalPath:o.originalPath,resolvedFrom:a})}return{value:o.value,type:o.type,originalReference:e,originalPath:o.originalPath,isResolved:!0,resolvedFrom:a}}const i=function(e,t){const n=Object.keys(t);let o=null,r=0;const s=e.toLowerCase();for(const e of n){const t=e.toLowerCase();if(t.endsWith(s)){const n=s.length/t.length;n>r&&(o=e,r=n)}else{const n=s.split(/[\/\.]/),a=t.split(/[\/\.]/);if(n[n.length-1]===a[a.length-1]){const t=.5;t>r&&(o=e,r=t)}}}return o}(o,t);if(i){const o=t[i];if("string"==typeof o.value&&o.value.startsWith("{")&&o.value.endsWith("}")){const r=s(o.value,t,n);return Object.assign(Object.assign({},r),{originalReference:e,originalPath:o.originalPath,resolvedFrom:i})}return{value:o.value,type:o.type,originalReference:e,originalPath:o.originalPath,isResolved:!0,resolvedFrom:i}}return{value:e,type:"reference",originalReference:e,isResolved:!1}}function a(t,n,o,r){if(null==t)return null;if("object"==typeof t&&("VARIABLE_ALIAS"===t.type||"VARIABLE_REFERENCE"===t.type))return function(e,t,n){if(!e||"object"!=typeof e)return e;if(("VARIABLE_ALIAS"===e.type||"VARIABLE_REFERENCE"===e.type)&&e.id){const o=t.find((t=>t.id===e.id));if(o){const t=o.name.replace(/\//g,".");return e.id&&t&&n.set(e.id,t),`{${t}}`}}return e}(t,o,r);if("object"==typeof t&&"r"in t&&"g"in t&&"b"in t)return e(t);if(Array.isArray(t))return t.map((e=>a(e,n,o,r)));if("object"==typeof t&&null!==t){if(0===Object.keys(t).length)return"{}";const e={};for(const s in t)e[s]=a(t[s],n,o,r);return e}return t}function i(){return e=this,o=void 0,i=function*(){try{console.log("Starting DTCG-compliant variable extraction");const e=yield figma.variables.getLocalVariableCollections();console.log("Collections found:",e.length);const o=figma.variables.getLocalVariables(),r=new Map,i={};for(const s of e){const e=s.name.toLowerCase();console.log("Processing collection:",e),i[e]={};const c=o.filter((e=>e.variableCollectionId===s.id));console.log(`Found ${c.length} variables in collection ${e}`);for(const l of s.modes){const s=l.name;console.log(`Processing mode: ${s}`),i[e][s]={};for(const d of c){const c=d.valuesByMode[l.modeId];if(void 0===c)continue;const u=d.name.split("/").filter((e=>e.trim().length>0)),f=u.length>0?u:["base"],g=a(c,d.resolvedType,o,r),h=n(g,t(d.resolvedType,g),"");let p=i[e][s];for(let e=0;e<f.length-1;e++){const t=f[e];p[t]||(p[t]={}),p=p[t]}p[f[f.length-1]]=h}}}console.log("Validating references...");const c=function(e,t){const n=JSON.parse(JSON.stringify(e)),o={};if(t instanceof Map)for(const[e,n]of t.entries())o[n]={value:`{${n}}`,type:"reference"};else Object.assign(o,t);function r(e,t=""){if(e&&"object"==typeof e)if(Array.isArray(e))e.forEach(((e,n)=>r(e,`${t}[${n}]`)));else for(const n in e){const a=e[n],i=t?`${t}.${n}`:n;if(!n.startsWith("$")||"$value"===n)if("$value"===n&&"string"==typeof a&&a.startsWith("{")&&a.endsWith("}")){a.substring(1,a.length-1);const t=s(a,o);t.isResolved?(e.$originalValue=a,e.$value=t.value,e.$resolvedFrom=t.resolvedFrom,"reference"===e.$type&&t.type?e.$type=t.type:e.$type||(e.$type=t.type||"reference")):e.$type||(e.$type="reference")}else"object"==typeof a&&null!==a&&r(a,i)}}0===Object.keys(o).length&&Object.assign(o,function(e){const t={};function n(e,o="",r=""){if(e&&"object"==typeof e)if(void 0===e.$value||void 0===e.$type)for(const t in e){const s=o?`${o}/${t}`:t,a=r?`${r}.${t}`:t;"object"==typeof e[t]&&null!==e[t]&&n(e[t],s,a)}else{const n=o.replace(/\//g,".");t[n]={value:e.$value,type:e.$type,originalPath:r},t[o]={value:e.$value,type:e.$type,originalPath:r};const s=n.split(".");for(let a=s.length;a>0;a--){const i=s.slice(s.length-a).join(".");t[i]||i===n||(t[i]={value:e.$value,type:e.$type,originalPath:r});const c=s.slice(s.length-a).join("/");t[c]||c===o||(t[c]={value:e.$value,type:e.$type,originalPath:r})}const a=s[s.length-1];t[a]||(t[a]={value:e.$value,type:e.$type,originalPath:r})}}for(const t in e)for(const o in e[t])n(e[t][o],`${t}/${o}`,`${t}.${o}`),n(e[t][o],"","");return t}(e));for(const e in n)for(const t in n[e])r(n[e][t],`${e}.${t}`);return n}(i,r);return console.log("DTCG-compliant extraction finished"),c}catch(e){throw console.error("Error in extractDTCGVariables:",e),e}},new((r=void 0)||(r=Promise))((function(t,n){function s(e){try{c(i.next(e))}catch(e){n(e)}}function a(e){try{c(i.throw(e))}catch(e){n(e)}}function c(e){var n;e.done?t(e.value):(n=e.value,n instanceof r?n:new r((function(e){e(n)}))).then(s,a)}c((i=i.apply(e,o||[])).next())}));var e,o,r,i}var c=function(e,t,n,o){return new(n||(n=Promise))((function(r,s){function a(e){try{c(o.next(e))}catch(e){s(e)}}function i(e){try{c(o.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,i)}c((o=o.apply(e,t||[])).next())}))};function l(e){return c(this,void 0,void 0,(function*(){try{if(console.log("Starting variable update process"),!e||"object"!=typeof e)return{success:!1,error:"Invalid JSON data provided"};const t=yield figma.variables.getLocalVariableCollections(),n=figma.variables.getLocalVariables();let o=0,r=0,s=0,a=0,i=0,l=0;const u=[],f=new Map,g=new Map;n.forEach((e=>{f.set(e.name.toLowerCase(),e),g.set(e.id,e.name)}));const h=new Map;t.forEach((e=>{h.set(e.name.toLowerCase(),e.id)}));const p=new Map;t.forEach((e=>{const t=new Map;e.modes.forEach((e=>{t.set(e.name.toLowerCase(),e.modeId)})),p.set(e.id,t)}));const m=function(e){const t=new Set;function n(e,o=""){e&&"object"==typeof e&&Object.entries(e).forEach((([e,r])=>{const s=o?`${o}/${e}`:e;r&&"object"==typeof r&&("$value"in r&&"$type"in r?t.add(s):n(r,s))}))}return Object.entries(e).forEach((([e,t])=>{"object"==typeof t&&null!==t&&Object.entries(t).forEach((([e,t])=>{"object"==typeof t&&null!==t&&n(t)}))})),t}(e),y=yield function(e,t,n){return c(this,void 0,void 0,(function*(){let o=0,r=0,s=0;const a=[],i=new Set,c=Object.keys(e);for(const l of c){console.log(`Processing collection: ${l}`);let d=t.find((e=>e.name.toLowerCase()===l.toLowerCase()));if(d)i.add(l.toLowerCase());else{const e=t.filter((e=>!c.some((t=>t.toLowerCase()===e.name.toLowerCase()))&&!i.has(e.name.toLowerCase())));if(e.length>0){const t=e[0];console.log(`Renaming collection: ${t.name} to ${l}`);try{t.name=l,d=t,s++,i.add(t.name.toLowerCase()),i.add(l.toLowerCase())}catch(e){const n=`Error renaming collection ${t.name} to ${l}: ${e instanceof Error?e.message:String(e)}`;console.error(n),a.push(n)}}if(!d){console.log(`Creating new collection: ${l}`);try{d=figma.variables.createVariableCollection(l),o++,i.add(l.toLowerCase())}catch(e){const t=`Error creating collection ${l}: ${e instanceof Error?e.message:String(e)}`;console.error(t),a.push(t);continue}}}const u=e[l],f=Object.keys(u),g=new Set;n.get(d.id)||new Map;for(const e of f)if(console.log(`Processing mode: ${e} in collection ${l}`),d.modes.some((t=>t.name.toLowerCase()===e.toLowerCase())))g.add(e.toLowerCase());else{const t=d.modes.filter((e=>!f.some((t=>t.toLowerCase()===e.name.toLowerCase()))&&!g.has(e.name.toLowerCase())));if(t.length>0){const n=t[0];console.log(`Renaming mode: ${n.name} to ${e} in collection ${l}`);try{d.renameMode(n.modeId,e),s++,g.add(n.name.toLowerCase()),g.add(e.toLowerCase())}catch(t){const o=`Error renaming mode ${n.name} to ${e}: ${t instanceof Error?t.message:String(t)}`;console.error(o),a.push(o)}}else{console.log(`Creating new mode: ${e} in collection ${l}`);try{d.addMode(e),r++,g.add(e.toLowerCase())}catch(t){const n=`Error creating mode ${e} in collection ${l}: ${t instanceof Error?t.message:String(t)}`;console.error(n),a.push(n)}}}}return{collectionsCreated:o,modesCreated:r,renamedCount:s,warnings:a}}))}(e,t,p);s+=y.collectionsCreated,a+=y.modesCreated,i+=y.renamedCount,u.push(...y.warnings);const $=yield figma.variables.getLocalVariableCollections();h.clear(),$.forEach((e=>{h.set(e.name.toLowerCase(),e.id)})),p.clear(),$.forEach((e=>{const t=new Map;e.modes.forEach((e=>{t.set(e.name.toLowerCase(),e.modeId)})),p.set(e.id,t)}));const{created:v,updated:b,renamed:w,processingWarnings:C}=yield function(e,t,n,o,r,s){return c(this,void 0,void 0,(function*(){let a=0,i=0,c=0;const l=[],u=new Set,f=new Map;for(const[g,h]of Object.entries(e)){if("object"!=typeof h||null===h){l.push(`Invalid collection data for ${g}`);continue}const e=o.get(g.toLowerCase());if(!e){l.push(`Collection not found: ${g}`);continue}if(!s.find((t=>t.id===e))){l.push(`Collection not found with ID: ${e}`);continue}const p=r.get(e);if(p&&0!==p.size)for(const[o,r]of Object.entries(h)){if("object"!=typeof r||null===r){l.push(`Invalid mode data for ${g}.${o}`);continue}const s=p.get(o.toLowerCase());if(!s){l.push(`Mode not found: ${o} in collection ${g}`);continue}const{createdCount:h,updatedCount:m,renamedCount:y,warnings:$,processedIds:v,renamedPaths:b}=yield d(r,e,s,t,n,f,"");a+=h,i+=m,c+=y,l.push(...$),v.forEach((e=>u.add(e))),b.forEach(((e,t)=>f.set(t,e)))}else l.push(`No modes found for collection: ${g}`)}return{created:a,updated:i,renamed:c,processingWarnings:l}}))}(e,n,f,h,p,$);o=v,r=b,i+=w,u.push(...C),function(e,t,n){const o=new Set;e.forEach((e=>{const t=e.split("/");t.length>0&&o.add(t[0].toLowerCase())}));const r=new Set;n.forEach((e=>{o.has(e.name.toLowerCase())&&r.add(e.id)}));t.filter((t=>!!r.has(t.variableCollectionId)&&!e.has(t.name)))}(m,n,$);const E=[];o>0&&E.push(`created ${o} variables`),r>0&&E.push(`updated ${r} variables`),s>0&&E.push(`created ${s} collections`),a>0&&E.push(`created ${a} modes`),i>0&&E.push(`renamed ${i} items`),l>0&&E.push(`deleted ${l} variables`);const L=E.join(", ");if(console.log(`Variable update completed successfully: ${L}`),0===o&&0===r&&0===s&&0===a&&0===i&&0===l)return{success:!0,error:"No variables, collections, or modes were updated. The provided data might be empty or already match the current state."};if(u.length>0){console.warn(`Operation completed with ${u.length} warnings`);const e=Array.from(new Set(u));return{success:!0,warnings:e,error:`Variables updated with ${e.length} warning(s).`,created:o,updated:r,collections:s,modes:a,renamed:i,deleted:l}}return{success:!0,created:o,updated:r,collections:s,modes:a,renamed:i,deleted:l}}catch(e){return console.error("Error updating variables:",e),{success:!1,error:e instanceof Error?e.message:"Unknown error updating variables"}}}))}function d(e,t,n,o,r,s){return c(this,arguments,void 0,(function*(e,t,n,o,r,s,a=""){let i=0,c=0,l=0;const g=[],p=new Set,m=new Map;for(const[y,$]of Object.entries(e)){const v=a?`${a}/${y}`:y;if($&&"object"==typeof $&&"$value"in $&&"$type"in $)try{const e=yield u(v,$,t,n,o,r,s);"created"===e.action&&i++,"updated"===e.action&&c++,"renamed"===e.action&&(l++,m.set(e.oldPath||"",v)),e.warning&&g.push(e.warning),e.variableId&&p.add(e.variableId)}catch(e){const t=`Error processing token ${v}: ${e instanceof Error?e.message:String(e)}`;console.error(t),g.push(t)}else if($&&"object"==typeof $&&!Array.isArray($)){const a=f(v,o,r,e);if(a.isRename){const{renamedCount:e,warnings:t,processedIds:n}=yield h(a.oldPath,v,o,p);l+=e,g.push(...t),n.forEach((e=>p.add(e))),a.oldPath&&m.set(a.oldPath,v)}const u=yield d($,t,n,o,r,s,v);i+=u.createdCount,c+=u.updatedCount,l+=u.renamedCount,g.push(...u.warnings),u.processedIds.forEach((e=>p.add(e))),u.renamedPaths.forEach(((e,t)=>m.set(t,e)))}}return{createdCount:i,updatedCount:c,renamedCount:l,warnings:g,processedIds:p,renamedPaths:m}}))}function u(e,t,n,o,r,s,a){return c(this,void 0,void 0,(function*(){let i,c=s.get(e.toLowerCase()),l=!1;if(!c){const t=function(e,t,n,o){const r=e.split("/"),s=r[r.length-1],a=r.slice(0,-1).join("/"),i=t.filter((e=>{const t=e.name.split("/"),n=t[t.length-1];return t.slice(0,-1).join("/")===a&&!o.has(e.name.toLowerCase())&&p(n,s)}));if(i.length>0)return{variable:i[0],oldPath:i[0].name,confidence:.9};const c=t.filter((e=>{const t=e.name.split("/"),n=t[t.length-1];return!o.has(e.name.toLowerCase())&&n===s}));if(c.length>0)return{variable:c[0],oldPath:c[0].name,confidence:.85};const l=t.filter((e=>{const t=e.name.split("/"),n=t[t.length-1];return!o.has(e.name.toLowerCase())&&p(n,s)}));return l.length>0?(l.sort(((e,t)=>{const n=e.name.split("/").pop()||"",o=t.name.split("/").pop()||"",r=m(n,s);return m(o,s)-r})),{variable:l[0],oldPath:l[0].name,confidence:.7}):{confidence:0}}(e,r,0,a);t.variable&&(c=t.variable,i=t.oldPath,l=!0,console.log(`Found variable to rename: ${i} → ${e}`))}try{const r=function(e){switch(e.toLowerCase()){case"color":return"COLOR";case"number":case"dimension":case"spacing":case"borderWidth":case"borderRadius":case"fontWeight":case"lineHeight":case"fontSizes":case"size":case"opacity":return"FLOAT";case"string":case"fontFamily":case"fontStyle":case"textCase":case"textDecoration":case"duration":case"letterSpacing":return"STRING";case"boolean":return"BOOLEAN";default:return e.includes("color")?"COLOR":e.includes("size")||e.includes("width")||e.includes("height")?"FLOAT":(console.warn(`Unknown DTCG type "${e}" - defaulting to STRING`),"STRING")}}(t.$type);if(!r)return{action:"unchanged",warning:`Invalid variable type: ${t.$type} for ${e}`};const a=function(e,t){switch(t){case"color":return"string"==typeof e&&e.startsWith("{")&&e.endsWith("}")?v(e):null==(n=e)?{r:0,g:0,b:0,a:1}:"object"==typeof n&&null!==n&&"r"in n?n:"string"==typeof n&&n.startsWith("#")?function(e){try{3===(e=e.replace("#","")).length&&(e=e[0]+e[0]+e[1]+e[1]+e[2]+e[2]),4===e.length&&(e=e[0]+e[0]+e[1]+e[1]+e[2]+e[2]+e[3]+e[3]);let t=1;8===e.length&&(t=parseInt(e.slice(6,8),16)/255,e=e.substring(0,6));const n=parseInt(e.slice(0,2),16)/255,o=parseInt(e.slice(2,4),16)/255,r=parseInt(e.slice(4,6),16)/255;return isNaN(n)||isNaN(o)||isNaN(r)||isNaN(t)?(console.warn(`Invalid hex color values in: #${e}`),{r:0,g:0,b:0,a:1}):{r:n,g:o,b:r,a:t}}catch(t){return console.error(`Error parsing hex color: #${e}`,t),{r:0,g:0,b:0,a:1}}}(n):"string"==typeof n&&(n.startsWith("rgb(")||n.startsWith("rgba("))?function(e){try{let t=e.match(/rgba?\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)(?:\s*,\s*(\d*\.?\d+))?\s*\)/);if(t||(t=e.match(/rgba?\(\s*(\d+)\s+(\d+)\s+(\d+)(?:\s*\/\s*(\d*\.?\d+))?\s*\)/)),t||(t=e.match(/rgba?\(\s*(\d+(?:\.\d+)?)\s*[, ]\s*(\d+(?:\.\d+)?)\s*[, ]\s*(\d+(?:\.\d+)?)(?:\s*[/, ]\s*(\d*\.?\d+))?\s*\)/)),!t)return console.warn(`Failed to parse RGB color: ${e}`),{r:0,g:0,b:0,a:1};const n=parseInt(t[1],10)/255,o=parseInt(t[2],10)/255;return{r:n,g:o,b:parseInt(t[3],10)/255,a:void 0!==t[4]?parseFloat(t[4]):1}}catch(t){return console.error(`Error parsing RGB color: ${e}`,t),{r:0,g:0,b:0,a:1}}}(n):"string"==typeof n&&(n.startsWith("hsl(")||n.startsWith("hsla("))?function(e){try{let t=e.match(/hsla?\(\s*(\d+)(?:deg)?\s*,\s*(\d+)(?:%)\s*,\s*(\d+)(?:%)\s*(?:,\s*(\d*\.?\d+))?\s*\)/);if(t||(t=e.match(/hsla?\(\s*(\d+)(?:deg)?\s+(\d+)(?:%)\s+(\d+)(?:%)\s*(?:\/\s*(\d*\.?\d+))?\s*\)/)),t||(t=e.match(/hsla?\(\s*(\d+(?:\.\d+)?)(?:deg|rad|grad|turn)?\s*[, ]\s*(\d+(?:\.\d+)?)%?\s*[, ]\s*(\d+(?:\.\d+)?)%?(?:\s*[/, ]\s*(\d*\.?\d+))?\s*\)/)),!t)return console.warn(`Failed to parse HSL color: ${e}`),{r:0,g:0,b:0,a:1};const n=parseFloat(t[1]),o=parseFloat(t[2])/100,r=parseFloat(t[3])/100,s=void 0!==t[4]?parseFloat(t[4]):1,a=(e,t,n)=>(n<0&&(n+=1),n>1&&(n-=1),n<1/6?e+6*(t-e)*n:n<.5?t:n<2/3?e+(t-e)*(2/3-n)*6:e);let i,c,l;if(0===o)i=c=l=r;else{const e=r<.5?r*(1+o):r+o-r*o,t=2*r-e;i=a(t,e,(n/360+1/3)%1),c=a(t,e,n/360%1),l=a(t,e,(n/360-1/3+1)%1)}return{r:i,g:c,b:l,a:s}}catch(t){return console.error(`Error parsing HSL color: ${e}`,t),{r:0,g:0,b:0,a:1}}}(n):(console.warn(`Unrecognized color format: ${n}`),{r:0,g:0,b:0,a:1});case"number":return"string"==typeof e&&e.startsWith("{")&&e.endsWith("}")?v(e):"string"==typeof e?parseFloat(e):e;case"boolean":return"string"==typeof e&&e.startsWith("{")&&e.endsWith("}")?v(e):Boolean(e);default:return"string"==typeof e&&e.startsWith("{")&&e.endsWith("}")?v(e):e}var n}(t.$value,t.$type);if(null===a&&"string"==typeof t.$value&&t.$value.startsWith("{")&&t.$value.endsWith("}"))return{action:"unchanged",warning:`Could not resolve reference for ${e}: ${t.$value}`};if(c){if(l){const n=c.name;if(c.name=e,console.log(`Renamed variable: ${n} → ${e}`),t.$description&&c.description!==t.$description&&(c.description=t.$description),t.$scopes&&Array.isArray(t.$scopes)){const e=t.$scopes.filter((e=>y(e)));e.length>0&&!$(e,c.scopes)&&(c.scopes=e)}return yield c.setValueForMode(o,a),s.delete(n.toLowerCase()),s.set(e.toLowerCase(),c),{action:"renamed",variableId:c.id,oldPath:n}}{let e=!1;if(t.$description&&c.description!==t.$description&&(c.description=t.$description,e=!0),t.$scopes&&Array.isArray(t.$scopes)){const n=t.$scopes.filter((e=>y(e)));n.length>0&&!$(n,c.scopes)&&(c.scopes=n,e=!0)}const n=c.valuesByMode[o];return!((d=n)===(u=a)||d&&u&&("object"!=typeof d||"object"!=typeof u?d===u:"r"in d&&"g"in d&&"b"in d?Math.abs(d.r-u.r)<.001&&Math.abs(d.g-u.g)<.001&&Math.abs(d.b-u.b)<.001&&Math.abs((d.a||1)-(u.a||1))<.001:"VARIABLE_ALIAS"===d.type&&"VARIABLE_ALIAS"===u.type?d.id===u.id:JSON.stringify(d)===JSON.stringify(u)))&&(yield c.setValueForMode(o,a),e=!0),{action:e?"updated":"unchanged",variableId:c.id}}}if(console.log(`Creating new variable: ${e} of type ${r}`),c=figma.variables.createVariable(e,n,r),t.$description&&(c.description=t.$description),t.$scopes&&Array.isArray(t.$scopes)){const e=t.$scopes.filter((e=>y(e)));e.length>0&&(c.scopes=e)}return yield c.setValueForMode(o,a),s.set(e.toLowerCase(),c),{action:"created",variableId:c.id}}catch(t){return{action:"unchanged",warning:`Error processing ${e}: ${t instanceof Error?t.message:String(t)}`}}var d,u}))}function f(e,t,n,o){if(n.has(e.toLowerCase()))return{isRename:!1,confidence:0};const r=g(o);if(0===r)return{isRename:!1,confidence:0};const s=function(e,t,n){const o=new Map;t.forEach((e=>{var t;const n=e.name.split("/");if(n.length>1)for(let r=1;r<n.length;r++){const s=n.slice(0,r).join("/");o.has(s)||o.set(s,[]),null===(t=o.get(s))||void 0===t||t.push(e)}}));const r=[];return o.forEach(((t,o)=>{if(o===e)return;const s=Math.abs(t.length-n);let a=1-s/Math.max(t.length,n);s<=1&&(a+=.2),a=Math.min(a,1),r.push({path:o,confidence:a})})),r.sort(((e,t)=>t.confidence-e.confidence))}(e,t,r);return s.length>0&&s[0].confidence>.7?{isRename:!0,oldPath:s[0].path,confidence:s[0].confidence}:{isRename:!1,confidence:0}}function g(e){let t=0;for(const[n,o]of Object.entries(e))o&&"object"==typeof o&&("$value"in o&&"$type"in o?t++:t+=g(o));return t}function h(e,t,n,o){return c(this,void 0,void 0,(function*(){let r=0;const s=[],a=new Set;if(!e)return{renamedCount:0,warnings:[],processedIds:new Set};const i=n.filter((t=>t.name.startsWith(e+"/")));for(const n of i)try{const s=n.name.substring(e.length+1),i=`${t}/${s}`;if(o.has(n.id))continue;console.log(`Renaming group variable: ${n.name} → ${i}`),n.name,n.name=i,r++,a.add(n.id)}catch(e){const t=`Error renaming variable in group: ${e instanceof Error?e.message:String(e)}`;console.error(t),s.push(t)}return{renamedCount:r,warnings:s,processedIds:a}}))}function p(e,t){if(e.includes(t)||t.includes(e))return!0;const n=/^\d+$/.test(e),o=/^\d+$/.test(t);return n&&o?e.charAt(0)===t.charAt(0):m(e,t)>.6}function m(e,t){let n=0;const o=Array(e.length+1).fill(0).map((()=>Array(t.length+1).fill(0)));for(let r=1;r<=e.length;r++)for(let s=1;s<=t.length;s++)e[r-1]===t[s-1]&&(o[r][s]=o[r-1][s-1]+1,n=Math.max(n,o[r][s]));return n/Math.max(e.length,t.length)}function y(e){return["ALL_SCOPES","TEXT_CONTENT","CORNER_RADIUS","WIDTH_HEIGHT","GAP","ALL_FILLS","FRAME_FILL","SHAPE_FILL","TEXT_FILL","STROKE_COLOR","STROKE_FLOAT","EFFECT_FLOAT","EFFECT_COLOR","OPACITY","FONT_FAMILY","FONT_STYLE","FONT_WEIGHT","FONT_SIZE","LINE_HEIGHT","LETTER_SPACING","PARAGRAPH_SPACING","PARAGRAPH_INDENT"].includes(e)}function $(e,t){if(e.length!==t.length)return!1;for(let n=0;n<e.length;n++)if(e[n]!==t[n])return!1;return!0}function v(e){try{const t=e.substring(1,e.length-1).replace(/\./g,"/"),n=figma.variables.getLocalVariables(),o=n.find((e=>e.name===t));if(!o){console.warn(`Referenced variable not found: ${t}`);const e=n.find((e=>e.name.toLowerCase()===t.toLowerCase()));return e?(console.log(`Found case-insensitive match for ${t}: ${e.name}`),{type:"VARIABLE_ALIAS",id:e.id}):null}return{type:"VARIABLE_ALIAS",id:o.id}}catch(e){return console.error("Error resolving reference to Figma alias:",e),null}}let b=!0,w="hex",C=null;figma.showUI(__html__,{width:1080,height:800}),console.log("Plugin UI shown with updated dimensions"),figma.ui.onmessage=t=>{return n=void 0,s=void 0,c=function*(){if(console.log("Plugin received message from UI:",t.type),"ui-ready"===t.type){if(console.log("UI is ready, sending data"),b){b=!1;try{const e=yield i();C=JSON.parse(JSON.stringify(e)),console.log("Extracted DTCG-compliant tokens, sending to UI"),figma.ui.postMessage({type:"tokens-data",data:e})}catch(e){console.error("Error extracting tokens:",e),figma.ui.postMessage({type:"error",message:`Error extracting tokens: ${e instanceof Error?e.message:"Unknown error"}`})}}}else if("extract-tokens"===t.type)try{const e=yield i();C=JSON.parse(JSON.stringify(e)),console.log("Extracted tokens on demand, sending to UI"),figma.ui.postMessage({type:"tokens-data",data:e})}catch(e){console.error("Error extracting tokens:",e),figma.ui.postMessage({type:"error",message:`Error extracting tokens: ${e instanceof Error?e.message:"Unknown error"}`})}else if("apply-color-format"===t.type){if(t.colorFormat){w=t.colorFormat,console.log(`Color format set to: ${w}`);try{C||(C=yield i());const t=function(t,n){const s=JSON.parse(JSON.stringify(t));function a(t){if(t&&"object"==typeof t&&void 0!==t.$value){if("color"===t.$type){if("string"==typeof t.$value&&t.$value.startsWith("{")&&t.$value.endsWith("}"))return t;t.$value=function(t,n){if("string"==typeof t){if(t.startsWith("#")){const e=function(e){3===(e=e.replace("#","")).length&&(e=e[0]+e[0]+e[1]+e[1]+e[2]+e[2]);let t=1;8===e.length&&(t=parseInt(e.slice(6,8),16)/255,e=e.substring(0,6));const n=parseInt(e,16);return{r:(n>>16&255)/255,g:(n>>8&255)/255,b:(255&n)/255,a:t}}(t);switch(n){case"hex":return t;case"rgba":return o(e);case"hsla":return r(e)}}return t}if("object"==typeof t&&"r"in t&&"g"in t&&"b"in t)switch(n){case"hex":default:return e(t);case"rgba":return o(t);case"hsla":return r(t)}return t}(t.$value,n)}return t}if(t&&"object"==typeof t&&!Array.isArray(t))for(const e in t)t[e]=a(t[e]);return t}for(const e in s)for(const t in s[e])s[e][t]=a(s[e][t]);return s}(JSON.parse(JSON.stringify(C)),w);figma.ui.postMessage({type:"tokens-data",data:t})}catch(e){console.error("Error applying color format:",e),figma.ui.postMessage({type:"error",message:`Error applying color format: ${e instanceof Error?e.message:"Unknown error"}`})}}}else if("update-variables"===t.type)try{console.log("Received update variables request");const e=yield l(t.data);figma.ui.postMessage({type:"update-variables-result",success:e.success,error:e.error,warnings:e.warnings,created:e.created,updated:e.updated,collections:e.collections,modes:e.modes,renamed:e.renamed,deleted:e.deleted})}catch(e){console.error("Error handling variable update:",e),figma.ui.postMessage({type:"update-variables-result",success:!1,error:`Error handling variable update: ${e instanceof Error?e.message:"Unknown error"}`})}else"close"===t.type&&figma.closePlugin()},new((a=void 0)||(a=Promise))((function(e,t){function o(e){try{i(c.next(e))}catch(e){t(e)}}function r(e){try{i(c.throw(e))}catch(e){t(e)}}function i(t){var n;t.done?e(t.value):(n=t.value,n instanceof a?n:new a((function(e){e(n)}))).then(o,r)}i((c=c.apply(n,s||[])).next())}));var n,s,a,c}})();
(()=>{"use strict";function e(e){const t=Math.round(255*e.r).toString(16).padStart(2,"0"),r=Math.round(255*e.g).toString(16).padStart(2,"0"),o=Math.round(255*e.b).toString(16).padStart(2,"0");return"a"in e&&void 0!==e.a&&1!==e.a?`#${t}${r}${o}${Math.round(255*e.a).toString(16).padStart(2,"0")}`:`#${t}${r}${o}`}function t(e,t){switch(e){case"COLOR":return"color";case"FLOAT":return"number"==typeof t?"number":"string"==typeof t&&(t.endsWith("px")||t.endsWith("rem")||t.endsWith("em")||t.endsWith("%"))?"dimension":"number";case"STRING":return"string";case"BOOLEAN":return"boolean";default:return"number"==typeof t?"number":"string"==typeof t?t.startsWith("#")||t.startsWith("rgb")?"color":t.match(/\d+(\.\d+)?(px|rem|em|%)/)?"dimension":t.startsWith("{")&&t.endsWith("}")?"reference":"string":"boolean"==typeof t?"boolean":"string"}}function r(e,t,r=""){const o={$value:e,$type:t};return r&&(o.$description=r),o}function o({r:e,g:t,b:r,a:o=1}){const n=Math.round(255*e),s=Math.round(255*t),a=Math.round(255*r);return void 0!==o&&o<1?`rgba(${n}, ${s}, ${a}, ${o.toFixed(2)})`:`rgb(${n}, ${s}, ${a})`}function n({r:e,g:t,b:r,a:o=1}){var n;const s=function({r:e,g:t,b:r,a:o=1}){const n=Math.max(e,t,r),s=Math.min(e,t,r),a=n-s;let i=0,c=0,l=(n+s)/2;if(0!==a)switch(c=l>.5?a/(2-n-s):a/(n+s),n){case e:i=60*((t-r)/a+(t<r?6:0));break;case t:i=60*((r-e)/a+2);break;case r:i=60*((e-t)/a+4)}return{h:i,s:100*c,l:100*l,a:o}}({r:e,g:t,b:r,a:o});return void 0!==o&&o<1?`hsla(${Math.round(s.h)}deg, ${Math.round(s.s)}%, ${Math.round(s.l)}%, ${null===(n=s.a)||void 0===n?void 0:n.toFixed(2)})`:`hsl(${Math.round(s.h)}deg, ${Math.round(s.s)}%, ${Math.round(s.l)}%)`}function s(e,t,r=new Set){if(!e||"string"!=typeof e)return{value:e,type:"unknown",isResolved:!1};if(!e.startsWith("{")||!e.endsWith("}"))return{value:e,type:"unknown",isResolved:!1};const o=e.substring(1,e.length-1);if(r.has(o))return console.warn(`Circular reference detected: ${o}`),{value:e,type:"reference",originalReference:e,isResolved:!1};if(r.add(o),t[o]){const n=t[o];if("string"==typeof n.value&&n.value.startsWith("{")&&n.value.endsWith("}")){const a=s(n.value,t,r);return Object.assign(Object.assign({},a),{originalReference:e,originalPath:n.originalPath,resolvedFrom:o})}return{value:n.value,type:n.type,originalReference:e,originalPath:n.originalPath,isResolved:!0,resolvedFrom:o}}const n=o.includes("/")?o.replace(/\//g,"."):o.replace(/\./g,"/");if(t[n]){const o=t[n];if("string"==typeof o.value&&o.value.startsWith("{")&&o.value.endsWith("}")){const a=s(o.value,t,r);return Object.assign(Object.assign({},a),{originalReference:e,originalPath:o.originalPath,resolvedFrom:n})}return{value:o.value,type:o.type,originalReference:e,originalPath:o.originalPath,isResolved:!0,resolvedFrom:n}}const a=o.split(/[\/\.]/).pop()||"";if(a!==o&&t[a]){const o=t[a];if("string"==typeof o.value&&o.value.startsWith("{")&&o.value.endsWith("}")){const n=s(o.value,t,r);return Object.assign(Object.assign({},n),{originalReference:e,originalPath:o.originalPath,resolvedFrom:a})}return{value:o.value,type:o.type,originalReference:e,originalPath:o.originalPath,isResolved:!0,resolvedFrom:a}}const i=function(e,t){const r=Object.keys(t);let o=null,n=0;const s=e.toLowerCase();for(const e of r){const t=e.toLowerCase();if(t.endsWith(s)){const r=s.length/t.length;r>n&&(o=e,n=r)}else{const r=s.split(/[\/\.]/),a=t.split(/[\/\.]/);if(r[r.length-1]===a[a.length-1]){const t=.5;t>n&&(o=e,n=t)}}}return o}(o,t);if(i){const o=t[i];if("string"==typeof o.value&&o.value.startsWith("{")&&o.value.endsWith("}")){const n=s(o.value,t,r);return Object.assign(Object.assign({},n),{originalReference:e,originalPath:o.originalPath,resolvedFrom:i})}return{value:o.value,type:o.type,originalReference:e,originalPath:o.originalPath,isResolved:!0,resolvedFrom:i}}return{value:e,type:"reference",originalReference:e,isResolved:!1}}function a(t,r,o,n){if(null==t)return null;if("object"==typeof t&&("VARIABLE_ALIAS"===t.type||"VARIABLE_REFERENCE"===t.type))return function(e,t,r){if(!e||"object"!=typeof e)return e;if(("VARIABLE_ALIAS"===e.type||"VARIABLE_REFERENCE"===e.type)&&e.id){const o=t.find((t=>t.id===e.id));if(o){const t=o.name.replace(/\//g,".");return e.id&&t&&r.set(e.id,t),`{${t}}`}}return e}(t,o,n);if("object"==typeof t&&"r"in t&&"g"in t&&"b"in t)return e(t);if(Array.isArray(t))return t.map((e=>a(e,r,o,n)));if("object"==typeof t&&null!==t){if(0===Object.keys(t).length)return"{}";const e={};for(const s in t)e[s]=a(t[s],r,o,n);return e}return t}function i(){return e=this,o=void 0,i=function*(){try{console.log("Starting DTCG-compliant variable extraction");const e=yield figma.variables.getLocalVariableCollections();console.log("Collections found:",e.length);const o=figma.variables.getLocalVariables(),n=new Map,i={};for(const s of e){const e=s.name.toLowerCase();console.log("Processing collection:",e),i[e]={};const c=o.filter((e=>e.variableCollectionId===s.id));console.log(`Found ${c.length} variables in collection ${e}`);for(const l of s.modes){const s=l.name;console.log(`Processing mode: ${s}`),i[e][s]={};for(const d of c){const c=d.valuesByMode[l.modeId];if(void 0===c)continue;const u=d.name.split("/").filter((e=>e.trim().length>0)),f=u.length>0?u:["base"],g=a(c,d.resolvedType,o,n),p=r(g,t(d.resolvedType,g),"");let h=i[e][s];for(let e=0;e<f.length-1;e++){const t=f[e];h[t]||(h[t]={}),h=h[t]}h[f[f.length-1]]=p}}}console.log("Validating references...");const c=function(e,t){const r=JSON.parse(JSON.stringify(e)),o={};if(t instanceof Map)for(const[e,r]of t.entries())o[r]={value:`{${r}}`,type:"reference"};else Object.assign(o,t);function n(e,t=""){if(e&&"object"==typeof e)if(Array.isArray(e))e.forEach(((e,r)=>n(e,`${t}[${r}]`)));else for(const r in e){const a=e[r],i=t?`${t}.${r}`:r;if(!r.startsWith("$")||"$value"===r)if("$value"===r&&"string"==typeof a&&a.startsWith("{")&&a.endsWith("}")){a.substring(1,a.length-1);const t=s(a,o);t.isResolved?(e.$originalValue=a,e.$value=t.value,e.$resolvedFrom=t.resolvedFrom,"reference"===e.$type&&t.type?e.$type=t.type:e.$type||(e.$type=t.type||"reference")):e.$type||(e.$type="reference")}else"object"==typeof a&&null!==a&&n(a,i)}}0===Object.keys(o).length&&Object.assign(o,function(e){const t={};function r(e,o="",n=""){if(e&&"object"==typeof e)if(void 0===e.$value||void 0===e.$type)for(const t in e){const s=o?`${o}/${t}`:t,a=n?`${n}.${t}`:t;"object"==typeof e[t]&&null!==e[t]&&r(e[t],s,a)}else{const r=o.replace(/\//g,".");t[r]={value:e.$value,type:e.$type,originalPath:n},t[o]={value:e.$value,type:e.$type,originalPath:n};const s=r.split(".");for(let a=s.length;a>0;a--){const i=s.slice(s.length-a).join(".");t[i]||i===r||(t[i]={value:e.$value,type:e.$type,originalPath:n});const c=s.slice(s.length-a).join("/");t[c]||c===o||(t[c]={value:e.$value,type:e.$type,originalPath:n})}const a=s[s.length-1];t[a]||(t[a]={value:e.$value,type:e.$type,originalPath:n})}}for(const t in e)for(const o in e[t])r(e[t][o],`${t}/${o}`,`${t}.${o}`),r(e[t][o],"","");return t}(e));for(const e in r)for(const t in r[e])n(r[e][t],`${e}.${t}`);return r}(i,n);return console.log("DTCG-compliant extraction finished"),c}catch(e){throw console.error("Error in extractDTCGVariables:",e),e}},new((n=void 0)||(n=Promise))((function(t,r){function s(e){try{c(i.next(e))}catch(e){r(e)}}function a(e){try{c(i.throw(e))}catch(e){r(e)}}function c(e){var r;e.done?t(e.value):(r=e.value,r instanceof n?r:new n((function(e){e(r)}))).then(s,a)}c((i=i.apply(e,o||[])).next())}));var e,o,n,i}var c=function(e,t,r,o){return new(r||(r=Promise))((function(n,s){function a(e){try{c(o.next(e))}catch(e){s(e)}}function i(e){try{c(o.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(a,i)}c((o=o.apply(e,t||[])).next())}))};function l(e,t,r,o,n,s){return c(this,arguments,void 0,(function*(e,t,r,o,n,s,a=""){var i,c;let p=!1,h=0,m=0;const $=[],v=new Set,y=Object.keys(t).sort(((e,r)=>{const o=e=>{const r=t[e];return r&&"object"==typeof r&&void 0!==r.$value&&"string"==typeof r.$value&&r.$value.startsWith("{")&&r.$value.endsWith("}")},n=e.split("/").length,s=r.split("/").length;if(n!==s)return n-s;const a=o(e);return a!==o(r)?a?1:-1:e.localeCompare(r)}));if(a&&t&&"object"==typeof t){new Set;const r=new Map;e.forEach((e=>{var t;const o=e.name.split("/");if(o.length>1){const n=o.slice(0,-1).join("/");r.has(n)||r.set(n,[]),null===(t=r.get(n))||void 0===t||t.push(e)}}));const o=a;let n="",s=[];for(const[e,a]of r.entries()){if(e===o)continue;const r=Object.keys(t).filter((e=>t[e]&&"object"==typeof t[e]&&void 0!==t[e].$value)).length;if(Math.abs(a.length-r)<=1){n=e,s=a;break}}if(n&&s.length>0){console.log(`Detected group rename: ${n} -> ${o}`);for(const e of s){const t=e.name.split("/"),r=`${o}/${t[t.length-1]}`;console.log(`Renaming group variable: ${e.name} -> ${r}`);try{e.name=r,v.add(e.id)}catch(e){console.error(`Error renaming variable in group: ${e}`),$.push(`Error renaming variable in group: ${e instanceof Error?e.message:String(e)}`)}}}}for(const b of y){const y=t[b],w=a?`${a}/${b}`:b;if(y&&"object"==typeof y&&void 0!==y.$value){const l=w;let E=e.find((e=>e.name===l)),C=!1;if(!E){const r=l.split("/"),o=r[r.length-1],n=r.slice(0,-1).join("/"),s=e.filter((e=>{const t=e.name.split("/"),r=t.slice(0,-1).join("/"),s=t[t.length-1];if(r!==n)return!1;if(s.includes(o)||o.includes(s))return!0;const a=/^\d+$/.test(o),i=/^\d+$/.test(s);return!(!a||!i)&&o.charAt(0)===s.charAt(0)}));if(s.length>0&&(console.log(`Found similar variable in same group: ${s[0].name} → ${l}`),E=s[0],C=!0,v.add(E.id)),!E){const r=e.filter((e=>{const t=e.name.split("/");return t[t.length-1]===o}));if(r.length>0){const e=new Set;Object.keys(t).forEach((r=>{if(r===b)return;const o=t[r];if(o&&"object"==typeof o&&void 0!==o.$value){const t=a?`${a}/${r}`:r;e.add(t)}}));const o=r.filter((t=>!Array.from(e).some((e=>e===t.name))));o.length>0&&(E=o[0],C=!0,console.log(`Renaming variable: ${E.name} to ${l}`),v.add(E.id))}}}try{const t="string"==typeof y.$value&&y.$value.startsWith("{")&&y.$value.endsWith("}"),a=d(y.$value,y.$type);if(null===a&&t){console.warn(`Could not resolve reference for variable ${l}: ${y.$value}`),$.push(`Could not resolve reference for ${l}: ${y.$value}`);continue}if(E){if(C){const t=E.name;try{E.name=l,console.log(`Renamed variable: ${t} to ${l}`)}catch(e){console.error(`Error renaming variable ${t} to ${l}:`,e),$.push(`Error renaming variable: ${e instanceof Error?e.message:String(e)}`)}if(s){const e=l.split("/");if(e.length>1){const t=e.slice(0,e.length-1).join("/");s.has(t)||s.set(t,new Set),null===(i=s.get(t))||void 0===i||i.add(l)}else s.has("")||s.set("",new Set),null===(c=s.get(""))||void 0===c||c.add(l)}if(e.push(E),y.$description&&(E.description=y.$description),y.$scopes&&Array.isArray(y.$scopes))try{const e=y.$scopes.filter((e=>u(e)));e.length>0&&(E.scopes=e)}catch(e){console.warn(`Could not set scopes for ${l}:`,e)}m++}else if(y.$description&&E.description!==y.$description&&(E.description=y.$description),y.$scopes&&Array.isArray(y.$scopes))try{const e=y.$scopes.filter((e=>u(e)));e.length>0&&!f(e,E.scopes)&&(E.scopes=e)}catch(e){console.warn(`Could not update scopes for ${l}:`,e)}}else{const e=g(y.$type);if(!e){console.error(`Invalid variable type: ${y.$type}`),$.push(`Invalid variable type: ${y.$type}`);continue}let t;if(n)t=n;else{const e=o.split(".")[0],r=figma.variables.getLocalVariableCollections().find((t=>t.name.toLowerCase()===e.toLowerCase()));if(!r){console.error(`Collection not found: ${e}`),$.push(`Collection not found: ${e}`);continue}t=r.id}console.log(`Creating new variable: ${l} of type ${e}`),E=figma.variables.createVariable(l,t,e)}yield E.setValueForMode(r,a),t?console.log(`${E?"Updated":"Created"} variable with reference: ${l} → ${y.$value}`):console.log(`${E?"Updated":"Created"} variable: ${l}`),v.add(E.id),p=!0,h++}catch(e){console.error(`Error updating/creating variable ${l}:`,e),$.push(`Error with ${l}: ${e instanceof Error?e.message:String(e)}`)}}else if(y&&"object"==typeof y&&!Array.isArray(y)){const t=yield l(e,y,r,o,n,s,w);p=p||t.updated,h+=t.updatedCount,m+=t.createdCount,t.referenceErrors&&t.referenceErrors.length>0&&$.push(...t.referenceErrors)}}return{updated:p,updatedCount:h,createdCount:m,referenceErrors:$,processedVariableIds:v}}))}function d(e,t){switch(t){case"color":return"string"==typeof e&&e.startsWith("{")&&e.endsWith("}")?p(e):null==(r=e)?{r:0,g:0,b:0,a:1}:"object"==typeof r&&null!==r&&"r"in r?r:"string"==typeof r&&r.startsWith("#")?function(e){try{3===(e=e.replace("#","")).length&&(e=e[0]+e[0]+e[1]+e[1]+e[2]+e[2]),4===e.length&&(e=e[0]+e[0]+e[1]+e[1]+e[2]+e[2]+e[3]+e[3]);let t=1;8===e.length&&(t=parseInt(e.slice(6,8),16)/255,e=e.substring(0,6));const r=parseInt(e.slice(0,2),16)/255,o=parseInt(e.slice(2,4),16)/255,n=parseInt(e.slice(4,6),16)/255;return isNaN(r)||isNaN(o)||isNaN(n)||isNaN(t)?(console.warn(`Invalid hex color values in: #${e}`),{r:0,g:0,b:0,a:1}):{r,g:o,b:n,a:t}}catch(t){return console.error(`Error parsing hex color: #${e}`,t),{r:0,g:0,b:0,a:1}}}(r):"string"==typeof r&&(r.startsWith("rgb(")||r.startsWith("rgba("))?function(e){try{let t=e.match(/rgba?\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)(?:\s*,\s*(\d*\.?\d+))?\s*\)/);if(t||(t=e.match(/rgba?\(\s*(\d+)\s+(\d+)\s+(\d+)(?:\s*\/\s*(\d*\.?\d+))?\s*\)/)),t||(t=e.match(/rgba?\(\s*(\d+(?:\.\d+)?)\s*[, ]\s*(\d+(?:\.\d+)?)\s*[, ]\s*(\d+(?:\.\d+)?)(?:\s*[/, ]\s*(\d*\.?\d+))?\s*\)/)),!t)return console.warn(`Failed to parse RGB color: ${e}`),{r:0,g:0,b:0,a:1};const r=parseInt(t[1],10)/255,o=parseInt(t[2],10)/255;return{r,g:o,b:parseInt(t[3],10)/255,a:void 0!==t[4]?parseFloat(t[4]):1}}catch(t){return console.error(`Error parsing RGB color: ${e}`,t),{r:0,g:0,b:0,a:1}}}(r):"string"==typeof r&&(r.startsWith("hsl(")||r.startsWith("hsla("))?function(e){try{let t=e.match(/hsla?\(\s*(\d+)(?:deg)?\s*,\s*(\d+)(?:%)\s*,\s*(\d+)(?:%)\s*(?:,\s*(\d*\.?\d+))?\s*\)/);if(t||(t=e.match(/hsla?\(\s*(\d+)(?:deg)?\s+(\d+)(?:%)\s+(\d+)(?:%)\s*(?:\/\s*(\d*\.?\d+))?\s*\)/)),t||(t=e.match(/hsla?\(\s*(\d+(?:\.\d+)?)(?:deg|rad|grad|turn)?\s*[, ]\s*(\d+(?:\.\d+)?)%?\s*[, ]\s*(\d+(?:\.\d+)?)%?(?:\s*[/, ]\s*(\d*\.?\d+))?\s*\)/)),!t)return console.warn(`Failed to parse HSL color: ${e}`),{r:0,g:0,b:0,a:1};const r=parseFloat(t[1]),o=parseFloat(t[2])/100,n=parseFloat(t[3])/100,s=void 0!==t[4]?parseFloat(t[4]):1,a=(e,t,r)=>(r<0&&(r+=1),r>1&&(r-=1),r<1/6?e+6*(t-e)*r:r<.5?t:r<2/3?e+(t-e)*(2/3-r)*6:e);let i,c,l;if(0===o)i=c=l=n;else{const e=n<.5?n*(1+o):n+o-n*o,t=2*n-e;i=a(t,e,(r/360+1/3)%1),c=a(t,e,r/360%1),l=a(t,e,(r/360-1/3+1)%1)}return{r:i,g:c,b:l,a:s}}catch(t){return console.error(`Error parsing HSL color: ${e}`,t),{r:0,g:0,b:0,a:1}}}(r):(console.warn(`Unrecognized color format: ${r}`),{r:0,g:0,b:0,a:1});case"number":return"string"==typeof e&&e.startsWith("{")&&e.endsWith("}")?p(e):"string"==typeof e?parseFloat(e):e;case"boolean":return"string"==typeof e&&e.startsWith("{")&&e.endsWith("}")?p(e):Boolean(e);default:return"string"==typeof e&&e.startsWith("{")&&e.endsWith("}")?p(e):e}var r}function u(e){return["ALL_SCOPES","TEXT_CONTENT","CORNER_RADIUS","WIDTH_HEIGHT","GAP","ALL_FILLS","FRAME_FILL","SHAPE_FILL","TEXT_FILL","STROKE_COLOR","STROKE_FLOAT","EFFECT_FLOAT","EFFECT_COLOR","OPACITY","FONT_FAMILY","FONT_STYLE","FONT_WEIGHT","FONT_SIZE","LINE_HEIGHT","LETTER_SPACING","PARAGRAPH_SPACING","PARAGRAPH_INDENT"].includes(e)}function f(e,t){if(e.length!==t.length)return!1;for(let r=0;r<e.length;r++)if(e[r]!==t[r])return!1;return!0}function g(e){switch(e.toLowerCase()){case"color":return"COLOR";case"number":case"dimension":case"spacing":case"borderWidth":case"borderRadius":case"fontWeight":case"lineHeight":case"fontSizes":case"size":case"opacity":return"FLOAT";case"string":case"fontFamily":case"fontStyle":case"textCase":case"textDecoration":case"duration":case"letterSpacing":return"STRING";case"boolean":return"BOOLEAN";default:return e.includes("color")?"COLOR":e.includes("size")||e.includes("width")||e.includes("height")?"FLOAT":(console.warn(`Unknown DTCG type "${e}" - defaulting to STRING`),"STRING")}}function p(e){try{const t=e.substring(1,e.length-1).replace(/\./g,"/"),r=figma.variables.getLocalVariables(),o=r.find((e=>e.name===t));if(!o){console.warn(`Referenced variable not found: ${t}`);const e=r.find((e=>e.name.toLowerCase()===t.toLowerCase()));return e?(console.log(`Found case-insensitive match for ${t}: ${e.name}`),{type:"VARIABLE_ALIAS",id:e.id}):null}return{type:"VARIABLE_ALIAS",id:o.id}}catch(e){return console.error("Error resolving reference to Figma alias:",e),null}}let h=!0,m="hex",$=null;figma.showUI(__html__,{width:1080,height:800}),console.log("Plugin UI shown with updated dimensions"),figma.ui.onmessage=t=>{return r=void 0,s=void 0,d=function*(){if(console.log("Plugin received message from UI:",t.type),"ui-ready"===t.type){if(console.log("UI is ready, sending data"),h){h=!1;try{const e=yield i();$=JSON.parse(JSON.stringify(e)),console.log("Extracted DTCG-compliant tokens, sending to UI"),figma.ui.postMessage({type:"tokens-data",data:e})}catch(e){console.error("Error extracting tokens:",e),figma.ui.postMessage({type:"error",message:`Error extracting tokens: ${e instanceof Error?e.message:"Unknown error"}`})}}}else if("extract-tokens"===t.type)try{const e=yield i();$=JSON.parse(JSON.stringify(e)),console.log("Extracted tokens on demand, sending to UI"),figma.ui.postMessage({type:"tokens-data",data:e})}catch(e){console.error("Error extracting tokens:",e),figma.ui.postMessage({type:"error",message:`Error extracting tokens: ${e instanceof Error?e.message:"Unknown error"}`})}else if("apply-color-format"===t.type){if(t.colorFormat){m=t.colorFormat,console.log(`Color format set to: ${m}`);try{$||($=yield i());const t=function(t,r){const s=JSON.parse(JSON.stringify(t));function a(t){if(t&&"object"==typeof t&&void 0!==t.$value){if("color"===t.$type){if("string"==typeof t.$value&&t.$value.startsWith("{")&&t.$value.endsWith("}"))return t;t.$value=function(t,r){if("string"==typeof t){if(t.startsWith("#")){const e=function(e){3===(e=e.replace("#","")).length&&(e=e[0]+e[0]+e[1]+e[1]+e[2]+e[2]);let t=1;8===e.length&&(t=parseInt(e.slice(6,8),16)/255,e=e.substring(0,6));const r=parseInt(e,16);return{r:(r>>16&255)/255,g:(r>>8&255)/255,b:(255&r)/255,a:t}}(t);switch(r){case"hex":return t;case"rgba":return o(e);case"hsla":return n(e)}}return t}if("object"==typeof t&&"r"in t&&"g"in t&&"b"in t)switch(r){case"hex":default:return e(t);case"rgba":return o(t);case"hsla":return n(t)}return t}(t.$value,r)}return t}if(t&&"object"==typeof t&&!Array.isArray(t))for(const e in t)t[e]=a(t[e]);return t}for(const e in s)for(const t in s[e])s[e][t]=a(s[e][t]);return s}(JSON.parse(JSON.stringify($)),m);figma.ui.postMessage({type:"tokens-data",data:t})}catch(e){console.error("Error applying color format:",e),figma.ui.postMessage({type:"error",message:`Error applying color format: ${e instanceof Error?e.message:"Unknown error"}`})}}}else if("update-variables"===t.type)try{console.log("Received update variables request");const e=yield function(e){return c(this,void 0,void 0,(function*(){var t,r;try{if(console.log("Starting variable update process"),!e||"object"!=typeof e)return{success:!1,error:"Invalid JSON data provided"};const o=yield figma.variables.getLocalVariableCollections();let n=!1,s=0,a=0,i=0,c=0,d=0,u=0;const f=[],g=[],p=(new Set,Object.keys(e)),h=(o.map((e=>e.name.toLowerCase())),new Map);o.forEach((e=>{const t=new Set;e.modes.forEach((e=>{t.add(e.name.toLowerCase())})),h.set(e.name.toLowerCase(),t)}));const m=new Map;for(const e of o){const o=figma.variables.getLocalVariables().filter((t=>t.variableCollectionId===e.id)),n=new Map;for(const e of o){const o=e.name.split("/");if(1===o.length)n.has("")||n.set("",new Set),null===(t=n.get(""))||void 0===t||t.add(e.name);else{const t=o.slice(0,o.length-1).join("/"),s=e.name;n.has(t)||n.set(t,new Set),null===(r=n.get(t))||void 0===r||r.add(s)}}m.set(e.name.toLowerCase(),n)}for(const t of p){console.log(`Processing collection: ${t}`);let r=o.find((e=>e.name.toLowerCase()===t.toLowerCase()));if(!r){const e=new Set,n=o.filter((t=>!p.some((e=>e.toLowerCase()===t.name.toLowerCase()))&&!e.has(t.name.toLowerCase())));if(n.length>0){const o=n[0];console.log(`Renaming collection: ${o.name} to ${t}`);try{if(o.name=t,r=o,d++,e.add(o.name.toLowerCase()),e.add(t.toLowerCase()),m.has(o.name.toLowerCase())){const e=m.get(o.name.toLowerCase());e&&(m.delete(o.name.toLowerCase()),m.set(t.toLowerCase(),e))}}catch(e){console.error(`Error renaming collection ${o.name} to ${t}:`,e),g.push(`Error renaming collection: ${e instanceof Error?e.message:String(e)}`)}}if(!r){console.log(`Creating new collection: ${t}`);try{r=figma.variables.createVariableCollection(t),i++,m.set(t.toLowerCase(),new Map),1===i&&o.push(r)}catch(e){console.error(`Error creating collection ${t}:`,e),g.push(`Error creating collection ${t}: ${e instanceof Error?e.message:String(e)}`);continue}}}const u=figma.variables.getLocalVariables().filter((e=>e.variableCollectionId===r.id)),h=e[t],$=Object.keys(h);for(const e of $){console.log(`Processing mode: ${e}`);let o=r.modes.find((t=>t.name.toLowerCase()===e.toLowerCase()));if(!o){const n=r.modes,s=new Set,a=n.filter((e=>!$.some((t=>t.toLowerCase()===e.name.toLowerCase()))&&!s.has(e.name.toLowerCase())));if(a.length>0){const t=a[0];console.log(`Renaming mode: ${t.name} to ${e}`);try{r.renameMode(t.modeId,e),o=r.modes.find((e=>e.modeId===t.modeId)),d++,s.add(t.name.toLowerCase()),s.add(e.toLowerCase())}catch(r){console.error(`Error renaming mode ${t.name} to ${e}:`,r),g.push(`Error renaming mode: ${r instanceof Error?r.message:String(r)}`)}}if(!o){console.log(`Creating new mode: ${e} in collection ${t}`);try{const t=r.addMode(e);if(c++,o=r.modes.find((e=>e.modeId===t)),!o)throw new Error(`Failed to find newly created mode: ${e}`)}catch(r){console.error(`Error creating mode ${e} in collection ${t}:`,r),g.push(`Error creating mode ${e}: ${r instanceof Error?r.message:String(r)}`);continue}}}const i=h[e],p=yield l(u,i,o.modeId,`${t}.${e}`,r.id,m.get(t.toLowerCase()));n=n||p.updated,a+=p.updatedCount||0,s+=p.createdCount||0,p.referenceErrors&&p.referenceErrors.length>0&&f.push(...p.referenceErrors)}}const $=new Set,v=(e,t="")=>{e&&"object"==typeof e&&Object.entries(e).forEach((([e,r])=>{const o=t?`${t}/${e}`:e;r&&"object"==typeof r&&"$value"in r&&"$type"in r?$.add(o):r&&"object"==typeof r&&v(r,o)}))};Object.entries(e).forEach((([e,t])=>{"object"==typeof t&&Object.entries(t).forEach((([t,r])=>{v(r,`${e}/${t}`)}))})),console.log(`Found ${$.size} variables in the JSON data`),figma.variables.getLocalVariables();const y=new Set;o.forEach((t=>{e[t.name]&&y.add(t.id)}));const b=[];for(const e of b)try{console.log(`Deleting variable: ${e.name}`),e.remove(),u++}catch(t){console.error(`Error deleting variable ${e.name}:`,t),g.push(`Error deleting variable: ${t instanceof Error?t.message:String(t)}`)}if(!n&&0===i&&0===c&&0===d&&0===u)return console.log("No variables, collections, or modes were updated, created, renamed or deleted - possibly empty input"),{success:!0,error:"No variables, collections, or modes were updated, created, renamed or deleted. The filter might be too restrictive or data is empty."};const w=[...f,...g];if(w.length>0){console.warn(`Operation completed with ${w.length} warnings`);const e=Array.from(new Set(w));return{success:!0,warnings:e,error:`Variables updated with ${e.length} warning(s).`,created:s,updated:a,collections:i,modes:c,renamed:d,deleted:u}}const E=[];s>0&&E.push(`created ${s} variables`),a>0&&E.push(`updated ${a} variables`),i>0&&E.push(`created ${i} collections`),c>0&&E.push(`created ${c} modes`),d>0&&E.push(`renamed ${d} items`);const C=E.join(", ");return console.log(`Variable update completed successfully: ${C}`),{success:!0,created:s,updated:a,collections:i,modes:c,renamed:d,deleted:0}}catch(e){return console.error("Error updating variables:",e),{success:!1,error:e instanceof Error?e.message:"Unknown error updating variables"}}}))}(t.data);figma.ui.postMessage({type:"update-variables-result",success:e.success,error:e.error,warnings:e.warnings,created:e.created,updated:e.updated,collections:e.collections,modes:e.modes,renamed:e.renamed,deleted:e.deleted})}catch(e){console.error("Error handling variable update:",e),figma.ui.postMessage({type:"update-variables-result",success:!1,error:`Error handling variable update: ${e instanceof Error?e.message:"Unknown error"}`})}else"close"===t.type&&figma.closePlugin()},new((a=void 0)||(a=Promise))((function(e,t){function o(e){try{i(d.next(e))}catch(e){t(e)}}function n(e){try{i(d.throw(e))}catch(e){t(e)}}function i(t){var r;t.done?e(t.value):(r=t.value,r instanceof a?r:new a((function(e){e(r)}))).then(o,n)}i((d=d.apply(r,s||[])).next())}));var r,s,a,d}})();
(()=>{"use strict";function e(e){const t=Math.round(255*e.r).toString(16).padStart(2,"0"),n=Math.round(255*e.g).toString(16).padStart(2,"0"),r=Math.round(255*e.b).toString(16).padStart(2,"0");return"a"in e&&void 0!==e.a&&1!==e.a?`#${t}${n}${r}${Math.round(255*e.a).toString(16).padStart(2,"0")}`:`#${t}${n}${r}`}function t(e,t){switch(e){case"COLOR":return"color";case"FLOAT":return"number"==typeof t?"number":"string"==typeof t&&(t.endsWith("px")||t.endsWith("rem")||t.endsWith("em")||t.endsWith("%"))?"dimension":"number";case"STRING":return"string";case"BOOLEAN":return"boolean";default:return"number"==typeof t?"number":"string"==typeof t?t.startsWith("#")||t.startsWith("rgb")?"color":t.match(/\d+(\.\d+)?(px|rem|em|%)/)?"dimension":t.startsWith("{")&&t.endsWith("}")?"reference":"string":"boolean"==typeof t?"boolean":"string"}}function n(e,t,n=""){const r={$value:e,$type:t};return n&&(r.$description=n),r}function r({r:e,g:t,b:n,a:r=1}){const o=Math.round(255*e),i=Math.round(255*t),s=Math.round(255*n);return void 0!==r&&r<1?`rgba(${o}, ${i}, ${s}, ${r.toFixed(2)})`:`rgb(${o}, ${i}, ${s})`}function o({r:e,g:t,b:n,a:r=1}){var o;const i=function({r:e,g:t,b:n,a:r=1}){const o=Math.max(e,t,n),i=Math.min(e,t,n),s=o-i;let a=0,l=0,c=(o+i)/2;if(0!==s)switch(l=c>.5?s/(2-o-i):s/(o+i),o){case e:a=60*((t-n)/s+(t<n?6:0));break;case t:a=60*((n-e)/s+2);break;case n:a=60*((e-t)/s+4)}return{h:a,s:100*l,l:100*c,a:r}}({r:e,g:t,b:n,a:r});return void 0!==r&&r<1?`hsla(${Math.round(i.h)}deg, ${Math.round(i.s)}%, ${Math.round(i.l)}%, ${null===(o=i.a)||void 0===o?void 0:o.toFixed(2)})`:`hsl(${Math.round(i.h)}deg, ${Math.round(i.s)}%, ${Math.round(i.l)}%)`}function i(e,t,n=new Set){if(!e||"string"!=typeof e)return{value:e,type:"unknown",isResolved:!1};if(!e.startsWith("{")||!e.endsWith("}"))return{value:e,type:"unknown",isResolved:!1};const r=e.substring(1,e.length-1);if(n.has(r))return console.warn(`Circular reference detected: ${r}`),{value:e,type:"reference",originalReference:e,isResolved:!1};if(n.add(r),t[r]){const o=t[r];if("string"==typeof o.value&&o.value.startsWith("{")&&o.value.endsWith("}")){const s=i(o.value,t,n);return Object.assign(Object.assign({},s),{originalReference:e,originalPath:o.originalPath,resolvedFrom:r})}return{value:o.value,type:o.type,originalReference:e,originalPath:o.originalPath,isResolved:!0,resolvedFrom:r}}const o=r.includes("/")?r.replace(/\//g,"."):r.replace(/\./g,"/");if(t[o]){const r=t[o];if("string"==typeof r.value&&r.value.startsWith("{")&&r.value.endsWith("}")){const s=i(r.value,t,n);return Object.assign(Object.assign({},s),{originalReference:e,originalPath:r.originalPath,resolvedFrom:o})}return{value:r.value,type:r.type,originalReference:e,originalPath:r.originalPath,isResolved:!0,resolvedFrom:o}}const s=r.split(/[\/\.]/).pop()||"";if(s!==r&&t[s]){const r=t[s];if("string"==typeof r.value&&r.value.startsWith("{")&&r.value.endsWith("}")){const o=i(r.value,t,n);return Object.assign(Object.assign({},o),{originalReference:e,originalPath:r.originalPath,resolvedFrom:s})}return{value:r.value,type:r.type,originalReference:e,originalPath:r.originalPath,isResolved:!0,resolvedFrom:s}}const a=function(e,t){const n=Object.keys(t);let r=null,o=0;const i=e.toLowerCase();for(const e of n){const t=e.toLowerCase();if(t.endsWith(i)){const n=i.length/t.length;n>o&&(r=e,o=n)}else{const n=i.split(/[\/\.]/),s=t.split(/[\/\.]/);if(n[n.length-1]===s[s.length-1]){const t=.5;t>o&&(r=e,o=t)}}}return r}(r,t);if(a){const r=t[a];if("string"==typeof r.value&&r.value.startsWith("{")&&r.value.endsWith("}")){const o=i(r.value,t,n);return Object.assign(Object.assign({},o),{originalReference:e,originalPath:r.originalPath,resolvedFrom:a})}return{value:r.value,type:r.type,originalReference:e,originalPath:r.originalPath,isResolved:!0,resolvedFrom:a}}return{value:e,type:"reference",originalReference:e,isResolved:!1}}function s(t,n,r,o){if(null==t)return null;if("object"==typeof t&&("VARIABLE_ALIAS"===t.type||"VARIABLE_REFERENCE"===t.type))return function(e,t,n){if(!e||"object"!=typeof e)return e;if(("VARIABLE_ALIAS"===e.type||"VARIABLE_REFERENCE"===e.type)&&e.id){const r=t.find((t=>t.id===e.id));if(r){const t=r.name.replace(/\//g,".");return e.id&&t&&n.set(e.id,t),`{${t}}`}}return e}(t,r,o);if("object"==typeof t&&"r"in t&&"g"in t&&"b"in t)return e(t);if(Array.isArray(t))return t.map((e=>s(e,n,r,o)));if("object"==typeof t&&null!==t){if(0===Object.keys(t).length)return"{}";const e={};for(const i in t)e[i]=s(t[i],n,r,o);return e}return t}function a(){return e=this,r=void 0,a=function*(){try{console.log("Starting DTCG-compliant variable extraction");const e=yield figma.variables.getLocalVariableCollections();console.log("Collections found:",e.length);const r=figma.variables.getLocalVariables(),o=new Map,a={};for(const i of e){const e=i.name.toLowerCase();console.log("Processing collection:",e),a[e]={};const l=r.filter((e=>e.variableCollectionId===i.id));console.log(`Found ${l.length} variables in collection ${e}`);for(const c of i.modes){const i=c.name;console.log(`Processing mode: ${i}`),a[e][i]={};for(const u of l){const l=u.valuesByMode[c.modeId];if(void 0===l)continue;const f=u.name.split("/").filter((e=>e.trim().length>0)),g=f.length>0?f:["base"],d=s(l,u.resolvedType,r,o),p=n(d,t(u.resolvedType,d),"");let h=a[e][i];for(let e=0;e<g.length-1;e++){const t=g[e];h[t]||(h[t]={}),h=h[t]}h[g[g.length-1]]=p}}}console.log("Validating references...");const l=function(e,t){const n=JSON.parse(JSON.stringify(e)),r={};if(t instanceof Map)for(const[e,n]of t.entries())r[n]={value:`{${n}}`,type:"reference"};else Object.assign(r,t);function o(e,t=""){if(e&&"object"==typeof e)if(Array.isArray(e))e.forEach(((e,n)=>o(e,`${t}[${n}]`)));else for(const n in e){const s=e[n],a=t?`${t}.${n}`:n;if(!n.startsWith("$")||"$value"===n)if("$value"===n&&"string"==typeof s&&s.startsWith("{")&&s.endsWith("}")){s.substring(1,s.length-1);const t=i(s,r);t.isResolved?(e.$originalValue=s,e.$value=t.value,e.$resolvedFrom=t.resolvedFrom,"reference"===e.$type&&t.type?e.$type=t.type:e.$type||(e.$type=t.type||"reference")):e.$type||(e.$type="reference")}else"object"==typeof s&&null!==s&&o(s,a)}}0===Object.keys(r).length&&Object.assign(r,function(e){const t={};function n(e,r="",o=""){if(e&&"object"==typeof e)if(void 0===e.$value||void 0===e.$type)for(const t in e){const i=r?`${r}/${t}`:t,s=o?`${o}.${t}`:t;"object"==typeof e[t]&&null!==e[t]&&n(e[t],i,s)}else{const n=r.replace(/\//g,".");t[n]={value:e.$value,type:e.$type,originalPath:o},t[r]={value:e.$value,type:e.$type,originalPath:o};const i=n.split(".");for(let s=i.length;s>0;s--){const a=i.slice(i.length-s).join(".");t[a]||a===n||(t[a]={value:e.$value,type:e.$type,originalPath:o});const l=i.slice(i.length-s).join("/");t[l]||l===r||(t[l]={value:e.$value,type:e.$type,originalPath:o})}const s=i[i.length-1];t[s]||(t[s]={value:e.$value,type:e.$type,originalPath:o})}}for(const t in e)for(const r in e[t])n(e[t][r],`${t}/${r}`,`${t}.${r}`),n(e[t][r],"","");return t}(e));for(const e in n)for(const t in n[e])o(n[e][t],`${e}.${t}`);return n}(a,o);return console.log("DTCG-compliant extraction finished"),l}catch(e){throw console.error("Error in extractDTCGVariables:",e),e}},new((o=void 0)||(o=Promise))((function(t,n){function i(e){try{l(a.next(e))}catch(e){n(e)}}function s(e){try{l(a.throw(e))}catch(e){n(e)}}function l(e){var n;e.done?t(e.value):(n=e.value,n instanceof o?n:new o((function(e){e(n)}))).then(i,s)}l((a=a.apply(e,r||[])).next())}));var e,r,o,a}let l=!0,c="hex",u=null;figma.showUI(__html__,{width:1080,height:800}),console.log("Plugin UI shown with updated dimensions"),figma.ui.onmessage=t=>{return n=void 0,i=void 0,f=function*(){if(console.log("Plugin received message from UI:",t.type),"ui-ready"===t.type){if(console.log("UI is ready, sending data"),l){l=!1;try{const e=yield a();u=JSON.parse(JSON.stringify(e)),console.log("Extracted DTCG-compliant tokens, sending to UI"),figma.ui.postMessage({type:"tokens-data",data:e})}catch(e){console.error("Error extracting tokens:",e),figma.ui.postMessage({type:"error",message:`Error extracting tokens: ${e instanceof Error?e.message:"Unknown error"}`})}}}else if("extract-tokens"===t.type)try{const e=yield a();u=JSON.parse(JSON.stringify(e)),console.log("Extracted tokens on demand, sending to UI"),figma.ui.postMessage({type:"tokens-data",data:e})}catch(e){console.error("Error extracting tokens:",e),figma.ui.postMessage({type:"error",message:`Error extracting tokens: ${e instanceof Error?e.message:"Unknown error"}`})}else if("apply-color-format"===t.type){if(t.colorFormat){c=t.colorFormat,console.log(`Color format set to: ${c}`);try{u||(u=yield a());const t=function(t,n){const i=JSON.parse(JSON.stringify(t));function s(t){if(t&&"object"==typeof t&&void 0!==t.$value){if("color"===t.$type){if("string"==typeof t.$value&&t.$value.startsWith("{")&&t.$value.endsWith("}"))return t;t.$value=function(t,n){if("string"==typeof t){if(t.startsWith("#")){const e=function(e){3===(e=e.replace("#","")).length&&(e=e[0]+e[0]+e[1]+e[1]+e[2]+e[2]);let t=1;8===e.length&&(t=parseInt(e.slice(6,8),16)/255,e=e.substring(0,6));const n=parseInt(e,16);return{r:(n>>16&255)/255,g:(n>>8&255)/255,b:(255&n)/255,a:t}}(t);switch(n){case"hex":return t;case"rgb":case"rgba":return r(e);case"hsl":case"hsla":return o(e)}}return t}if("object"==typeof t&&"r"in t&&"g"in t&&"b"in t)switch(n){case"hex":default:return e(t);case"rgb":case"rgba":return r(t);case"hsl":case"hsla":return o(t)}return t}(t.$value,n)}return t}if(t&&"object"==typeof t&&!Array.isArray(t))for(const e in t)t[e]=s(t[e]);return t}for(const e in i)for(const t in i[e])i[e][t]=s(i[e][t]);return i}(JSON.parse(JSON.stringify(u)),c);figma.ui.postMessage({type:"tokens-data",data:t})}catch(e){console.error("Error applying color format:",e),figma.ui.postMessage({type:"error",message:`Error applying color format: ${e instanceof Error?e.message:"Unknown error"}`})}}}else"close"===t.type&&figma.closePlugin()},new((s=void 0)||(s=Promise))((function(e,t){function r(e){try{a(f.next(e))}catch(e){t(e)}}function o(e){try{a(f.throw(e))}catch(e){t(e)}}function a(t){var n;t.done?e(t.value):(n=t.value,n instanceof s?n:new s((function(e){e(n)}))).then(r,o)}a((f=f.apply(n,i||[])).next())}));var n,i,s,f}})();